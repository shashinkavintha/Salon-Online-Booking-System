import{V as ve,W as ge,r as c,o as pe,aa as k,a as ye,X as x,Y as i,Z as a,_ as xe,a1 as l,a0 as t,ad as b,ae as _,a8 as $,a7 as r,a6 as Q,J as S,ah as C,a3 as m,a4 as p,ai as N,a9 as be,a5 as d,a2 as q,ab as E,ac as L,af as H,aj as _e,ak as he,al as we}from"./index-BkdfeebD.js";import{Q as ke,a as V,b as y,c as O,C as qe}from"./ClosePopup-qF9Q4Odl.js";import{Q as te,a as De}from"./QChip-BKtxa_Gm.js";import{Q as Ce}from"./QForm-DGk-n1Pb.js";import{Q as Se}from"./QDate-BHi-22le.js";import{_ as Qe,Q as Ne}from"./_plugin-vue_export-helper-BLP6uk4h.js";import{u as Ve}from"./use-quasar-BaFF8fvc.js";import{d as D,u as Me}from"./useNotifications-DO5vzZcJ.js";import"./format-djG2a3QX.js";const Ye={class:"row q-col-gutter-lg",style:{"max-width":"1400px",margin:"0 auto"}},Ae={class:"col-12 col-md-3"},Be={class:"text-h5 font-serif text-weight-medium"},ze={class:"text-caption text-grey-5"},Pe={class:"col-12 col-md-9"},Ie={key:0,class:"fade-in"},Re={class:"row q-col-gutter-lg q-mb-xl"},Ue={class:"col-12 col-sm-4"},je={class:"row items-center justify-between q-mb-md"},Fe={class:"text-h3 text-weight-bold font-serif"},Te={class:"col-12 col-sm-4"},$e={class:"row items-center justify-between q-mb-md"},Ee={class:"text-h3 text-weight-bold font-serif"},Le={class:"col-12 col-sm-4"},He={class:"row items-center justify-between q-mb-md"},Oe={class:"text-h3 text-weight-bold font-serif"},We={class:"row items-center justify-between q-mb-lg"},Ge={class:"column flex-center q-py-xl text-center"},Je={key:1,class:"fade-in"},Ke={key:0,class:"column flex-center full-height q-py-xl"},Xe={key:1,class:"row q-col-gutter-md"},Ze={class:"row items-center justify-between"},et={class:"row items-center"},tt={class:"text-h6"},st={class:"text-caption text-grey-4"},at={class:"text-right"},lt={class:"text-weight-bold text-accent q-mb-sm"},ot={class:"row justify-end q-gutter-sm"},it={key:2,class:"fade-in"},nt={class:"row justify-between items-center q-mb-lg"},dt={key:0,class:"column flex-center full-height q-py-xl"},rt={key:1,class:"row q-col-gutter-md"},ct={class:"row items-center justify-between"},ut={class:"row items-center"},mt={class:"text-h6"},ft={class:"text-subtitle2 text-accent"},vt={class:"text-caption text-grey-4"},gt={class:"text-right"},pt={key:3,class:"fade-in"},yt={class:"q-pt-md"},xt={class:"row q-col-gutter-lg"},bt={class:"col-12 col-md-auto text-center"},_t={class:"col-12 col-md"},ht={key:0,class:"text-center q-pa-lg"},wt={key:1,class:"text-grey-6 text-center q-pa-lg"},kt={key:2,class:"text-grey-6 text-center q-pa-lg"},qt={key:3,class:"row q-gutter-sm justify-start"},Dt={__name:"UserDashboard",setup(Ct){const u=Ve(),se=xe(),ae=ve(),{user:h}=ge(ae),{sendNotification:W}=Me(),f=c("dashboard"),G=c(0),I=c(0),J=c(0),M=c([]),R=c([]),A=c(null),K=c(!1),v=c({fullName:"",email:"",phone:""}),B=c(!1),n=c({id:null,date:"",time:"",staffId:null}),U=c(!1),j=c(!1),X=c([]),le=["09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00"];pe(async()=>{if(h.value){v.value.email=h.value.email,v.value.fullName=h.value.user_metadata?.full_name||"";try{const{data:e}=await k.from("profiles").select("*").eq("id",h.value.id).single();e&&(v.value.fullName=e.full_name||h.value.user_metadata?.full_name,v.value.phone=e.phone||"",["admin","staff"].includes(e.role)&&(K.value=!0))}catch(e){console.error("Error fetching profile:",e)}const{data:o}=await k.from("staff").select("*").eq("user_id",h.value.id).maybeSingle();if(o){A.value=o;const{data:e}=await k.from("appointments").select("*, services(*), profiles(full_name, phone, email)").eq("staff_id",o.id).neq("status","cancelled").order("start_time",{ascending:!0});R.value=e||[]}z()}});const oe=async()=>{try{const o={id:h.value.id,full_name:v.value.fullName,phone:v.value.phone,updated_at:new Date},{error:e}=await k.from("profiles").upsert(o);if(e)throw e;u.notify({type:"positive",message:"Profile updated successfully"})}catch(o){u.notify({type:"negative",message:o.message||"Error updating profile"})}},ie=async()=>{const{error:o}=await k.auth.signOut();o?u.notify({type:"negative",message:o.message}):(u.notify({type:"positive",message:"Logged out successfully"}),se.push("/"))},Z=ye(()=>{if(!n.value.date)return[];const o=new Date,e=D.formatDate(o,"YYYY/MM/DD"),s=n.value.date===e;return le.map(g=>{let w=!0;if(X.value.includes(g)&&(w=!1),w&&s){const[Y,F]=g.split(":").map(Number),P=new Date(o);P.setHours(Y,F,0,0),D.getDateDiff(P,o,"minutes")<60&&(w=!1)}return{time:g,available:w}})}),ee=async o=>{if(!(!o||!n.value.staffId)){n.value.time=null,j.value=!0;try{const e=o.replaceAll("/","-"),{data:s,error:g}=await k.rpc("get_active_appointments_for_date",{p_staff_id:n.value.staffId,p_date:e});if(g)throw g;X.value=s.filter(w=>w.id!==n.value.id).map(w=>{const Y=new Date(w.start_time);return D.formatDate(Y,"HH:mm")})}catch(e){console.error(e)}finally{j.value=!1}}},ne=o=>{const e=new Date(o.start_time),s=D.formatDate(e,"YYYY/MM/DD");n.value={id:o.id,date:s,time:D.formatDate(e,"HH:mm"),staffId:o.staff_id},ee(s),B.value=!0},de=async()=>{if(!n.value.date||!n.value.time){u.notify({type:"warning",message:"Please select a date and time"});return}U.value=!0;try{const{id:o,date:e,time:s}=n.value,[g,w,Y]=e.split("/").map(Number),[F,P]=s.split(":").map(Number),fe=new Date(g,w-1,Y,F,P).toISOString(),{error:T}=await k.from("appointments").update({start_time:fe,status:"pending"}).eq("id",o);if(T)throw T.code==="23505"?new Error("Time slot unavailable"):T;W("rescheduled",{id:o}),u.notify({type:"positive",message:"Rescheduled successfully"}),B.value=!1,z()}catch(o){u.notify({type:"negative",message:"Error: "+o.message})}finally{U.value=!1}},re=async o=>{u.dialog({title:"Cancel Booking",message:"Are you sure you want to cancel?",cancel:!0,dark:!0,persistent:!0}).onOk(async()=>{const{error:e}=await k.from("appointments").update({status:"cancelled"}).eq("id",o);e?u.notify({type:"negative",message:"Failed to cancel"}):(W("cancelled",{id:o}),z(),u.notify({type:"positive",message:"Booking Cancelled"}))})},ce=async o=>{u.dialog({title:"Delete History",message:"Remove this record permanently?",cancel:!0,dark:!0,persistent:!0}).onOk(async()=>{const{error:e}=await k.from("appointments").delete().eq("id",o);e?u.notify({type:"negative",message:"Failed to delete"}):(M.value=M.value.filter(s=>s.id!==o),u.notify({type:"positive",message:"Deleted"}),z())})},z=async()=>{const{data:o}=await k.from("appointments").select("*, services(*)").eq("user_id",h.value.id).order("start_time",{ascending:!1});o&&(M.value=o,G.value=o.filter(e=>["pending","confirmed"].includes(e.status)).length,I.value=o.filter(e=>e.status==="completed").length,J.value=I.value*50)},ue=o=>o>=D.formatDate(Date.now(),"YYYY/MM/DD");return(o,e)=>(i(),x(Ne,{class:"q-pa-md q-pa-lg-xl bg-black text-white"},{default:a(()=>[l("div",Ye,[l("div",Ae,[t(b,{class:"bg-grey-10 no-shadow border-white-10 text-white",style:{"border-radius":"20px",position:"sticky",top:"100px"}},{default:a(()=>[t(_,{class:"text-center q-pt-xl"},{default:a(()=>[t($,{size:"120px",class:"q-mb-md shadow-10",style:{border:"3px solid #FF0000"}},{default:a(()=>[...e[9]||(e[9]=[l("img",{src:"https://cdn.quasar.dev/img/boy-avatar.png",alt:"User Avatar"},null,-1)])]),_:1}),l("div",Be,r(Q(h)?.user_metadata?.full_name||"Valued Guest"),1),l("div",ze,r(Q(h)?.email),1)]),_:1}),t(_,{class:"q-px-none q-pb-xl"},{default:a(()=>[t(ke,{class:"q-gutter-y-sm"},{default:a(()=>[S((i(),x(V,{clickable:"",active:f.value==="dashboard",onClick:e[0]||(e[0]=s=>f.value="dashboard"),"active-class":"active-nav-item",class:"nav-item q-py-md q-px-lg"},{default:a(()=>[t(y,{avatar:""},{default:a(()=>[t(m,{name:"dashboard",size:"24px"})]),_:1}),t(y,{class:"text-subtitle1"},{default:a(()=>[...e[10]||(e[10]=[p("Dashboard",-1)])]),_:1})]),_:1},8,["active"])),[[N]]),S((i(),x(V,{clickable:"",active:f.value==="bookings",onClick:e[1]||(e[1]=s=>f.value="bookings"),"active-class":"active-nav-item",class:"nav-item q-py-md q-px-lg"},{default:a(()=>[t(y,{avatar:""},{default:a(()=>[t(m,{name:"event_note",size:"24px"})]),_:1}),t(y,{class:"text-subtitle1"},{default:a(()=>[...e[11]||(e[11]=[p("My Bookings",-1)])]),_:1})]),_:1},8,["active"])),[[N]]),A.value?S((i(),x(V,{key:0,clickable:"",active:f.value==="schedule",onClick:e[2]||(e[2]=s=>f.value="schedule"),"active-class":"active-nav-item",class:"nav-item q-py-md q-px-lg"},{default:a(()=>[t(y,{avatar:""},{default:a(()=>[t(m,{name:"schedule",size:"24px"})]),_:1}),t(y,{class:"text-subtitle1"},{default:a(()=>[...e[12]||(e[12]=[p("My Schedule",-1)])]),_:1})]),_:1},8,["active"])),[[N]]):C("",!0),S((i(),x(V,{clickable:"",active:f.value==="profile",onClick:e[3]||(e[3]=s=>f.value="profile"),"active-class":"active-nav-item",class:"nav-item q-py-md q-px-lg"},{default:a(()=>[t(y,{avatar:""},{default:a(()=>[t(m,{name:"person",size:"24px"})]),_:1}),t(y,{class:"text-subtitle1"},{default:a(()=>[...e[13]||(e[13]=[p("Profile Settings",-1)])]),_:1})]),_:1},8,["active"])),[[N]]),t(be,{class:"bg-grey-9 q-my-md"}),K.value?S((i(),x(V,{key:1,clickable:"",to:"/admin",class:"nav-item q-py-md q-px-lg text-accent"},{default:a(()=>[t(y,{avatar:""},{default:a(()=>[t(m,{name:"admin_panel_settings",size:"24px"})]),_:1}),t(y,{class:"text-subtitle1"},{default:a(()=>[...e[14]||(e[14]=[p("Admin Panel",-1)])]),_:1})]),_:1})),[[N]]):C("",!0),S((i(),x(V,{clickable:"",onClick:ie,class:"nav-item text-red-5 q-py-md q-px-lg hover:text-red-7"},{default:a(()=>[t(y,{avatar:""},{default:a(()=>[t(m,{name:"logout",size:"24px"})]),_:1}),t(y,{class:"text-subtitle1"},{default:a(()=>[...e[15]||(e[15]=[p("Logout",-1)])]),_:1})]),_:1})),[[N]])]),_:1})]),_:1})]),_:1})]),l("div",Pe,[f.value==="dashboard"?(i(),d("div",Ie,[e[25]||(e[25]=l("div",{class:"text-h4 font-serif q-mb-lg"},"Welcome Back,",-1)),l("div",Re,[l("div",Ue,[t(b,{class:"stats-card bg-grey-10 text-white border-white-10"},{default:a(()=>[t(_,{class:"q-pa-lg"},{default:a(()=>[l("div",je,[e[16]||(e[16]=l("div",{class:"text-subtitle2 text-grey-5 text-uppercase tracking-wider"},"Upcoming",-1)),t(m,{name:"calendar_today",color:"accent",size:"24px"})]),l("div",Fe,r(G.value),1),e[17]||(e[17]=l("div",{class:"text-caption text-grey-6 q-mt-sm"},"Next appointment",-1))]),_:1})]),_:1})]),l("div",Te,[t(b,{class:"stats-card bg-grey-10 text-white border-white-10"},{default:a(()=>[t(_,{class:"q-pa-lg"},{default:a(()=>[l("div",$e,[e[18]||(e[18]=l("div",{class:"text-subtitle2 text-grey-5 text-uppercase tracking-wider"},"Completed",-1)),t(m,{name:"check_circle",color:"green-4",size:"24px"})]),l("div",Ee,r(I.value),1),e[19]||(e[19]=l("div",{class:"text-caption text-grey-6 q-mt-sm"},"Total Services",-1))]),_:1})]),_:1})]),l("div",Le,[t(b,{class:"stats-card bg-gradient-gold text-black"},{default:a(()=>[t(_,{class:"q-pa-lg"},{default:a(()=>[l("div",He,[e[20]||(e[20]=l("div",{class:"text-subtitle2 text-dark text-uppercase tracking-wider text-weight-bold"},"Points",-1)),t(m,{name:"stars",color:"black",size:"24px"})]),l("div",Oe,r(J.value),1),e[21]||(e[21]=l("div",{class:"text-caption text-dark q-mt-sm text-weight-medium"},"Silver Tier Status",-1))]),_:1})]),_:1})])]),t(b,{class:"bg-grey-10 text-white border-white-10"},{default:a(()=>[t(_,{class:"q-pa-lg"},{default:a(()=>[l("div",We,[e[22]||(e[22]=l("div",{class:"text-h5 font-serif"},"Recent Activity",-1)),t(q,{flat:"",dense:"",color:"accent",label:"View All","no-caps":""})]),l("div",Ge,[t(m,{name:"spa",color:"grey-8",size:"64px",class:"q-mb-md opacity-50"}),e[23]||(e[23]=l("div",{class:"text-h6 text-grey-5 q-mb-sm"},"No recent bookings",-1)),e[24]||(e[24]=l("p",{class:"text-grey-7 q-mb-lg",style:{"max-width":"300px"}},"Ready to transform your look? Explore our services and book your next session.",-1)),t(q,{unelevated:"",rounded:"",color:"accent","text-color":"white",label:"Book Appointment",to:"/book",class:"q-px-xl q-py-xs"})])]),_:1})]),_:1})])):C("",!0),f.value==="bookings"?(i(),d("div",Je,[t(b,{class:"bg-grey-10 text-white border-white-10",style:{"min-height":"400px"}},{default:a(()=>[t(_,{class:"q-pa-lg"},{default:a(()=>[e[30]||(e[30]=l("div",{class:"text-h4 font-serif q-mb-lg"},"My Appointments",-1)),M.value.length===0?(i(),d("div",Ke,[t(m,{name:"event_busy",color:"grey-8",size:"64px",class:"q-mb-md opacity-50"}),e[26]||(e[26]=l("div",{class:"text-h6 text-grey-5"},"No Appointments Found",-1)),t(q,{unelevated:"",rounded:"",color:"accent",label:"Book Now",to:"/book",class:"q-mt-md"})])):(i(),d("div",Xe,[(i(!0),d(E,null,L(M.value,s=>(i(),d("div",{class:"col-12",key:s.id},[t(b,{class:"bg-grey-9 border-white-10 q-pa-md booking-item"},{default:a(()=>[l("div",Ze,[l("div",et,[t($,{color:"accent","text-color":"white",icon:"spa",class:"q-mr-md","font-size":"24px"}),l("div",null,[l("div",tt,r(s.services?.name||"Service"),1),l("div",st,r(Q(D).formatDate(s.start_time,"dddd, MMMM D, YYYY"))+" at "+r(Q(D).formatDate(s.start_time,"h:mm A")),1)])]),l("div",at,[t(te,{color:s.status==="confirmed"?"green":s.status==="completed"?"blue":"orange",class:"q-pa-xs text-uppercase q-mb-xs"},{default:a(()=>[p(r(s.status),1)]),_:2},1032,["color"]),l("div",lt,"LKR "+r(s.services?.price),1),l("div",ot,[s.status!=="cancelled"&&s.status!=="completed"?(i(),x(q,{key:0,flat:"",round:"",dense:"",icon:"edit",color:"grey-5",onClick:g=>ne(s)},{default:a(()=>[t(O,null,{default:a(()=>[...e[27]||(e[27]=[p("Reschedule",-1)])]),_:1})]),_:1},8,["onClick"])):C("",!0),s.status!=="cancelled"&&s.status!=="completed"?(i(),x(q,{key:1,flat:"",round:"",dense:"",icon:"event_busy",color:"orange",onClick:g=>re(s.id)},{default:a(()=>[t(O,null,{default:a(()=>[...e[28]||(e[28]=[p("Cancel Booking",-1)])]),_:1})]),_:1},8,["onClick"])):C("",!0),t(q,{flat:"",round:"",dense:"",icon:"delete",color:"grey-8",onClick:g=>ce(s.id)},{default:a(()=>[t(O,null,{default:a(()=>[...e[29]||(e[29]=[p("Delete Record",-1)])]),_:1})]),_:1},8,["onClick"])])])])]),_:2},1024)]))),128))]))]),_:1})]),_:1})])):C("",!0),f.value==="schedule"?(i(),d("div",it,[t(b,{class:"bg-grey-10 text-white border-white-10",style:{"min-height":"400px"}},{default:a(()=>[t(_,{class:"q-pa-lg"},{default:a(()=>[l("div",nt,[e[31]||(e[31]=l("div",{class:"text-h4 font-serif"},"My Schedule",-1)),A.value?(i(),x(De,{key:0,color:"accent","text-color":"white"},{default:a(()=>[p(r(A.value.role),1)]),_:1})):C("",!0)]),R.value.length===0?(i(),d("div",dt,[t(m,{name:"free_breakfast",color:"grey-8",size:"64px",class:"q-mb-md opacity-50"}),e[32]||(e[32]=l("div",{class:"text-h6 text-grey-5"},"No jobs assigned yet",-1))])):(i(),d("div",rt,[(i(!0),d(E,null,L(R.value,s=>(i(),d("div",{class:"col-12",key:s.id},[t(b,{class:"bg-grey-9 border-white-10 q-pa-md booking-item"},{default:a(()=>[l("div",ct,[l("div",ut,[t($,{color:"blue-grey-8","text-color":"white",icon:"person",class:"q-mr-md","font-size":"24px"}),l("div",null,[l("div",mt,r(s.services?.name),1),l("div",ft,"Customer: "+r(s.profiles?.full_name||"Unknown"),1),l("div",vt,r(Q(D).formatDate(s.start_time,"dddd, MMMM D, YYYY"))+" at "+r(Q(D).formatDate(s.start_time,"h:mm A")),1)])]),l("div",gt,[t(te,{color:s.status==="confirmed"?"green":"orange",class:"q-pa-xs text-uppercase q-mb-xs"},{default:a(()=>[p(r(s.status),1)]),_:2},1032,["color"])])])]),_:2},1024)]))),128))]))]),_:1})]),_:1})])):C("",!0),f.value==="profile"?(i(),d("div",pt,[t(b,{class:"bg-grey-10 text-white border-white-10"},{default:a(()=>[t(_,{class:"q-pa-lg"},{default:a(()=>[e[33]||(e[33]=l("div",{class:"text-h4 font-serif q-mb-lg"},"Profile Settings",-1)),t(Ce,{class:"q-gutter-y-lg q-mt-md",style:{"max-width":"600px"}},{default:a(()=>[t(H,{dark:"",outlined:"",modelValue:v.value.fullName,"onUpdate:modelValue":e[4]||(e[4]=s=>v.value.fullName=s),label:"Full Name",color:"accent","bg-color":"grey-9"},null,8,["modelValue"]),t(H,{dark:"",outlined:"",modelValue:v.value.email,"onUpdate:modelValue":e[5]||(e[5]=s=>v.value.email=s),label:"Email Address",disable:"",color:"accent","bg-color":"grey-9"},{append:a(()=>[t(m,{name:"lock",color:"grey-6",size:"xs"})]),_:1},8,["modelValue"]),t(H,{dark:"",outlined:"",modelValue:v.value.phone,"onUpdate:modelValue":e[6]||(e[6]=s=>v.value.phone=s),label:"Phone Number",color:"accent","bg-color":"grey-9",mask:"(###) ### - ####"},null,8,["modelValue"]),l("div",yt,[t(q,{label:"Save Changes",color:"accent",unelevated:"",rounded:"",class:"q-px-xl",size:"lg",onClick:oe})])]),_:1})]),_:1})]),_:1})])):C("",!0)])]),t(_e,{modelValue:B.value,"onUpdate:modelValue":e[8]||(e[8]=s=>B.value=s)},{default:a(()=>[t(b,{class:"bg-grey-9 text-white border-white-10",style:{"min-width":"700px","max-width":"90vw"}},{default:a(()=>[t(_,null,{default:a(()=>[...e[34]||(e[34]=[l("div",{class:"text-h6 font-serif"},"Reschedule Appointment",-1),l("div",{class:"text-caption text-grey-5"},"Select a new date and time",-1)])]),_:1}),t(_,{class:"q-pa-md"},{default:a(()=>[l("div",xt,[l("div",bt,[t(Se,{modelValue:n.value.date,"onUpdate:modelValue":[e[7]||(e[7]=s=>n.value.date=s),ee],dark:"",color:"accent",minimal:"",class:"bg-grey-10 border-white-10 shadow-0",options:ue},null,8,["modelValue"])]),l("div",_t,[e[35]||(e[35]=l("div",{class:"text-subtitle2 q-mb-md"},"Available Slots",-1)),j.value?(i(),d("div",ht,[t(he,{color:"accent"})])):n.value.date?Z.value.every(s=>!s.available)?(i(),d("div",kt," No slots available for this date ")):(i(),d("div",qt,[(i(!0),d(E,null,L(Z.value,s=>(i(),x(q,{key:s.time,label:s.time,outline:n.value.time!==s.time,unelevated:n.value.time===s.time,color:n.value.time===s.time?"accent":s.available?"white":"grey-8","text-color":n.value.time===s.time||s.available?"white":"grey-6",rounded:"",class:"q-px-md",disable:!s.available,onClick:g=>n.value.time=s.time},null,8,["label","outline","unelevated","color","text-color","disable","onClick"]))),128))])):(i(),d("div",wt," Please select a date first "))])])]),_:1}),t(we,{align:"right",class:"q-pa-md bg-grey-10"},{default:a(()=>[S(t(q,{flat:"",label:"Cancel",color:"white"},null,512),[[qe]]),t(q,{unelevated:"",rounded:"",label:"Update Schedule",color:"accent",loading:U.value,onClick:de,disable:!n.value.date||!n.value.time},null,8,["loading","disable"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}},Pt=Qe(Dt,[["__scopeId","data-v-fbffedd3"]]);export{Pt as default};
